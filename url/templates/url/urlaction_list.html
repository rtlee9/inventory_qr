{% extends "base.html" %}
{% load tz %}

{% block extrastyles %}
<style>
    /* ── Page header ── */
    .dash-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .dash-header__left {
        display: flex;
        align-items: baseline;
        gap: 1rem;
    }

    .dash-title {
        font-family: var(--font-display);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-bright);
        margin: 0;
        letter-spacing: -0.03em;
    }

    .dash-count {
        font-family: var(--font-mono);
        font-size: 0.8rem;
        color: var(--text-muted);
        background: var(--bg-card);
        border: 1px solid var(--border);
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
    }

    /* ── Search ── */
    .dash-search {
        position: relative;
    }
    .dash-search__icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
        font-size: 0.85rem;
    }
    .dash-search__input {
        font-family: var(--font-mono);
        font-size: 0.8rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 0.5rem 0.75rem 0.5rem 2.1rem;
        border-radius: var(--radius-md);
        width: 240px;
        transition: all 0.2s ease;
        outline: none;
    }
    .dash-search__input::placeholder { color: var(--text-muted); }
    .dash-search__input:focus {
        border-color: var(--accent-indigo);
        background: var(--bg-card-hover);
        box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.1);
        width: 280px;
    }

    /* ── Card Grid ── */
    .url-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }

    .url-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 1.1rem 1.25rem;
        transition: all 0.25s ease;
        display: flex;
        flex-direction: column;
        text-decoration: none;
        color: inherit;
        position: relative;
        overflow: hidden;
    }
    .url-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--accent-indigo), var(--accent-sky));
        opacity: 0;
        transition: opacity 0.25s ease;
    }
    .url-card:hover {
        background: var(--bg-card-hover);
        border-color: var(--border-light);
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        color: inherit;
        text-decoration: none;
    }
    .url-card:hover::after {
        opacity: 1;
    }
    /* History badge */
    .url-card__type {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        font-family: var(--font-mono);
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
    }
    .url-card__type--create {
        background: rgba(74, 222, 128, 0.12);
        color: var(--accent-green);
    }
    .url-card__type--update {
        background: rgba(251, 191, 36, 0.12);
        color: var(--accent-amber);
    }
    .url-card__type--delete {
        background: rgba(248, 113, 113, 0.12);
        color: var(--accent-red);
    }

    /* Key label */
    .url-card__key {
        font-family: var(--font-mono);
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-bright);
        margin-bottom: 0.35rem;
        word-break: break-all;
    }

    /* Destination URL */
    .url-card__dest {
        font-size: 0.78rem;
        color: var(--text-secondary);
        margin-bottom: 0.6rem;
        line-height: 1.4;
        word-break: break-all;
        max-width: 100%;
    }

    /* Destination color bar */
    .url-card__bar {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 3px;
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
    }

    /* Timestamp */
    .url-card__meta {
        font-family: var(--font-mono);
        font-size: 0.7rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-top: auto;
    }

    /* ── Empty state ── */
    .empty-state {
        text-align: center;
        padding: 4rem 1rem;
    }
    .empty-state__icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    .empty-state__title {
        font-family: var(--font-display);
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }
    .empty-state__desc {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }
    .empty-state__cta {
        display: inline-block;
        font-family: var(--font-display);
        font-size: 0.85rem;
        font-weight: 500;
        background: var(--accent-indigo);
        color: #fff;
        text-decoration: none;
        padding: 0.5rem 1.25rem;
        border-radius: var(--radius-sm);
        transition: all 0.15s ease;
    }
    .empty-state__cta:hover {
        background: #6D75E8;
        color: #fff;
        text-decoration: none;
        transform: translateY(-1px);
    }

    /* No results from search */
    .no-results {
        display: none;
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-muted);
        font-size: 0.9rem;
        grid-column: 1 / -1;
    }

    /* ── Copy button ── */
    .url-card__copy {
        position: absolute;
        top: 0.65rem;
        right: 0.65rem;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-muted);
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s ease;
        z-index: 2;
    }
    .url-card:hover .url-card__copy {
        opacity: 1;
    }
    .url-card__copy:hover {
        color: var(--text-bright);
        border-color: var(--border-light);
        background: var(--bg-card);
    }
    .url-card__copy--done {
        color: var(--accent-green) !important;
        border-color: var(--accent-green) !important;
    }
    .url-card__copy svg {
        width: 14px;
        height: 14px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
    }
    /* History page: shift copy button left when type badge is present */
    .url-card__type ~ .url-card__copy {
        right: auto;
        left: 0.65rem;
    }

    @media (max-width: 640px) {
        .dash-header { flex-direction: column; align-items: stretch; }
        .dash-search__input { width: 100%; }
        .dash-search__input:focus { width: 100%; }
        .url-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-content">

    <div class="dash-header">
        <div class="dash-header__left">
            <h1 class="dash-title">
                {% if 'history' in request.path %}
                    History
                {% else %}
                    Dashboard
                {% endif %}
            </h1>
            {% if object_list %}
            <span class="dash-count">{{ object_list|length }} url{{ object_list|length|pluralize }}</span>
            {% endif %}
        </div>
        {% if object_list %}
        <div class="dash-search">
            <span class="dash-search__icon">&#x2315;</span>
            <input
                type="text"
                class="dash-search__input"
                id="cardSearch"
                placeholder="Search urls..."
                autocomplete="off"
            >
        </div>
        {% endif %}
    </div>

    {% if object_list %}
    <div class="url-grid" id="urlGrid">
        {% for object in object_list %}
        {% if object.was_successfull %}
        <a href="{{ object.get_absolute_url }}" class="url-card"
            data-search="{{ object.url_key|lower }} {{ object.long_url_cleaned|lower }}"
            data-dest="{{ object.long_url_cleaned }}">
            <span class="url-card__bar"></span>
            {% if 'history' in request.path %}
            <span class="url-card__type url-card__type--{{ object.action_type }}">{{ object.action_type }}</span>
            {% endif %}
            <button class="url-card__copy" data-url="https://aws3.link/{{ object.url_key }}" title="Copy short link" onclick="event.preventDefault(); event.stopPropagation(); copyLink(this);">
                <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            </button>
            <div class="url-card__key">{{ object.url_key }}</div>
            <div class="url-card__dest" title="{{ object.long_url_cleaned }}">{{ object.long_url_cleaned|truncatechars:60 }}</div>
            <div class="url-card__meta">
                {{ object.timestamp|timezone:"America/Los_Angeles"|date:"M j, Y \a\t g:i A" }}
            </div>
        </a>
        {% endif %}
        {% endfor %}
        <div class="no-results" id="noResults">No matching URLs found.</div>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state__icon">&#x25A3;</div>
        <div class="empty-state__title">No URLs yet</div>
        <div class="empty-state__desc">Create your first shortened URL to get started.</div>
        <a href="{% url 'create' %}" class="empty-state__cta">Create URL</a>
    </div>
    {% endif %}

</div>

<script>
function copyLink(btn) {
    var url = btn.getAttribute('data-url');
    navigator.clipboard.writeText(url).then(function() {
        btn.classList.add('url-card__copy--done');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>';
        setTimeout(function() {
            btn.classList.remove('url-card__copy--done');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
        }, 1500);
    });
}

(function() {
    function hashStr(s) {
        var h = 0;
        for (var i = 0; i < s.length; i++) {
            h = ((h << 5) - h + s.charCodeAt(i)) | 0;
        }
        return Math.abs(h);
    }
    var cards = document.querySelectorAll('.url-card[data-dest]');
    cards.forEach(function(card) {
        var dest = card.getAttribute('data-dest') || '';
        var bar = card.querySelector('.url-card__bar');
        if (!bar || !dest) return;
        var h = hashStr(dest) % 360;
        bar.style.background = 'hsl(' + h + ', 55%, 55%)';
    });
})();

(function() {
    var input = document.getElementById('cardSearch');
    if (!input) return;
    var grid = document.getElementById('urlGrid');
    var cards = grid.querySelectorAll('.url-card');
    var noResults = document.getElementById('noResults');

    input.addEventListener('input', function() {
        var q = this.value.toLowerCase().trim();
        var visible = 0;
        cards.forEach(function(card) {
            var data = card.getAttribute('data-search') || '';
            var match = !q || data.indexOf(q) !== -1;
            card.style.display = match ? '' : 'none';
            if (match) visible++;
        });
        noResults.style.display = visible === 0 ? 'block' : 'none';
    });
})();
</script>
{% endblock %}
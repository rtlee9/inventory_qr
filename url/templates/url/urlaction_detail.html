{% extends "base.html" %}
{% load tz %}

{% block extrastyles %}
<style>
    .json-details {
        margin: 0.5rem 0;
    }
    .json-details summary {
        cursor: pointer;
        color: var(--text-primary);
        padding: 0.3rem 0;
    }
    .json-details summary:hover {
        color: var(--text-bright);
    }
    .json-block {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin: 0.5rem 0 0;
        overflow-x: auto;
        font-family: var(--font-mono);
        font-size: 0.8rem;
        line-height: 1.6;
        color: var(--text-primary);
    }
    .json-block code {
        background: none;
        padding: 0;
        color: inherit;
        font-size: inherit;
    }
    /* Syntax colors */
    .json-key { color: var(--accent-sky); }
    .json-str { color: var(--accent-green); }
    .json-num { color: var(--accent-amber); }
    .json-bool { color: var(--accent-indigo); }
    .json-null { color: var(--text-muted); }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-6">
            <h3>{{ object.url_key }}</h3>
            <img src="{{ object.qr_url }}">
            <p><strong>Long URL:</strong> <a href="{{ object.long_url_cleaned }}">{{ object.long_url }}</a></p>
            <p><strong>URL Key:</strong> <a href="https://aws3.link/{{ object.url_key }}">{{ object.url_key }}</a></p>
        </div>
    </div>
    {% if 'hits' in tracking_data.keys %}
    <div class="row">
        <div class="col-md-6">
            <h3>Tracking data</h3>
            <p>Total hits: {{ tracking_data.totalHits }}</p>
            {% if tracking_data.totalHits|add:0 > 0 %}
            <table class="table" id="tracking-data" data-toggle="table" data-search="true" data-pagination="true">
                <thead>
                    <tr>
                        <th>Datetime</th>
                        <th>IP Address</th>
                        <th>Location</th>
                        <th>OS</th>
                        <th>Dist</th>
                        <th>Browser</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hit in tracking_data.hits %}
                    <tr>
                        <td>{{hit.datetime|timezone:"America/Los_Angeles"}}</td>
                        <td>{{hit.ip}}</td>
                        <td>
                            {% if 'ip_data' in hit.keys %}
                            {{hit.ip_data.city}}, {{hit.ip_data.region}}, {{hit.ip_data.countryCode}}
                            {% endif %}
                        </td>
                        <td>{{hit.user.os.name}}</td>
                        <td>{{hit.user.dist.name}} v{{hit.user.dist.version}}</td>
                        <td>{{hit.user.browser.name}} v{{hit.user.browser.version}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% if action_history %}
    <div class="row">
        <div class="col-md-8">
            <h3>Action history for <code>{{ object.url_key }}</code></h3>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Timestamp</th>
                        <th>JSON</th>
                    </tr>
                </thead>
                <tbody>
                    {% for action in action_history %}
                    <tr>
                        <td>{{ action.action_type }}</td>
                        <td class="{% if action.response_code == 200 %}text-success{% else %}text-danger{% endif %}">{{ action.response_code }}</td>
                        <td>{{ action.timestamp|timezone:"America/Los_Angeles" }}</td>
                        <td>
                            {% if action.response_json %}
                            <details class="json-details">
                                <summary>view</summary>
                                <pre class="json-block"><code class="responseJson">{{ action.response_json }}</code></pre>
                            </details>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% if latest_action.action_type != "delete" %}
    <div class="row">
        <div class="col-sm">
            <a href="{% url 'create' %}?url_key={{ object.url_key }}&action_type=delete"
                class="btn btn-outline-secondary my-2 my-sm-0">Delete URL key</a>
        </div>
        <div class="col-sm">
            <a href="{% url 'create' %}?url_key={{ object.url_key }}&action_type=update"
                class="btn btn-outline-secondary my-2 my-sm-0">Update URL key</a>
        </div>
    </div>
    {% endif %}
</div>

<script>
(function() {
    document.querySelectorAll('.responseJson').forEach(function(el) {
        var raw = el.textContent.trim();
        try {
            var obj = JSON.parse(raw);
        } catch(e) {
            try {
                obj = JSON.parse(raw.replace(/'/g, '"').replace(/None/g, 'null').replace(/True/g, 'true').replace(/False/g, 'false'));
            } catch(e2) {
                return;
            }
        }
        var pretty = JSON.stringify(obj, null, 2);
        el.innerHTML = pretty.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
            .replace(/"([^"]+)"(\s*:)/g, '<span class="json-key">"$1"</span>$2')
            .replace(/:\s*"([^"]*)"/g, ': <span class="json-str">"$1"</span>')
            .replace(/:\s*(\d+\.?\d*)/g, ': <span class="json-num">$1</span>')
            .replace(/:\s*(true|false)/g, ': <span class="json-bool">$1</span>')
            .replace(/:\s*(null)/g, ': <span class="json-null">$1</span>');
    });
})();
</script>
{% endblock %}